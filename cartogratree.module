<?php

/**
 * @file
 * Custom functionality for the CartograTree application.
 */

define("CARTOGRATREE_COMPATIBLE_MAJOR_VERSION", '4');

/**
 * Implements hook_libraries_info().
 * Define OpenLayers3 as external library.
 */
function cartogratree_libraries_info() {
    // Expected to be extracted into 'sites/all/libraries/openlayers'.
    $libraries = array();
    $libraries['openlayers'] = array(
      'name' => 'OpenLayers3',
      'vendor url' => 'http://openlayers.org',
      'download url' => 'https://openlayers.org/en/v4.1.1',
      'version' => '4.1.1',
      'version arguments' => array(
        // file where version can be found
        'file' => 'ol.js',
        // Version: v4.1.1
        'pattern' => '/Version: v([0-9\.]+)/',
        'lines' => 5,
      ),
      'files' => array(
        'js' => array(
          // https://openlayers.org/en/v4.1.1/build/ol.js
          'ol.js',
        ),
        'css' => array(
          // https://openlayers.org/en/v4.1.1/css/ol.css
          'ol.css',
        ),
      ),
    );
    return $libraries;
}

/**
 * Implements hook_menu().
 * Register paths in order to define how URL requests are handled.
 */
function cartogratree_menu() {
    $items = array();

    // User interface
    $items['cartogratree/app'] = array(
      'description' => 'Main UI of CartograTree.',
      'page callback' => 'cartogratree_app_page',
      'page arguments' => array(),
      'access arguments' => array('access content'),
    );

    // ADMINISTRATION.
    // List servers and layers.
    $items['admin/cartogratree/settings'] = array(
      'title' => 'CartograTree Settings',
      'description' => 'Provides a form so users can manage GIS server settings, and layers.',
      'page callback' => 'cartogratree_admin_list',
      'page arguments' => array(),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // ==============================================================================================================
    // -- Add servers.
    $items['admin/cartogratree/settings/servers/add'] = array(
      'title' => 'Add CartograTree Servers',
      'description' => 'Provide servers used by the CartograTree application.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_servers_form', 'add'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // -- Edit servers.
    $items['admin/cartogratree/settings/servers/edit'] = array(
      'title' => 'Update CartograTree Servers',
      'description' => 'Update servers used by the CartograTree application.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_servers_form', 'edit'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // ==============================================================================================================
    // -- Add group.
    $items['admin/cartogratree/settings/group/add'] = array(
      'title' => 'Add CartograTree groups for layers',
      'description' => 'Make a group available to the CartograTree application.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_group_form', 'add'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // -- Edit group.
    $items['admin/cartogratree/settings/group/edit'] = array(
      'title' => 'Edit CartograTree group',
      'description' => 'Edit an existing CartograTree group.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_group_form', 'edit'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // -- Delete group.
    $items['admin/cartogratree/settings/group/delete'] = array(
      'title' => 'Delete CartograTree group',
      'description' => 'Delete an existing CartograTree group.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_group_form', 'delete'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // -- Add subgroups
    $items['admin/cartogratree/settings/group/%/subgroups'] = array(
      'title' => 'Group management',
      'description' => 'Add or remove sublayers to a group.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_group_management_form', 4),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // -- Remove subgroup (no confirm)
    $items['admin/cartogratree/settings/group/%/remove-subgroup/%'] = array(
      'title' => 'Remove subgroup from group',
      'description' => 'Handle subgroup membership for a group.',
      'page callback' => 'cartogratree_admin_group_remove_subgroup',
      'page arguments' => array(4, 6),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // ==============================================================================================================
    // -- Add subgroup.
    $items['admin/cartogratree/settings/subgroup/add'] = array(
      'title' => 'Add CartograTree subgroup for layers',
      'description' => 'Make a subgroup available to the CartograTree application.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_subgroup_form', 'add'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // -- Edit subgroup.
    $items['admin/cartogratree/settings/subgroup/edit'] = array(
      'title' => 'Edit CartograTree subgroup',
      'description' => 'Edit an existing CartograTree subgroup.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_subgroup_form', 'edit'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // -- Delete subgroup.
    $items['admin/cartogratree/settings/subgroup/delete'] = array(
      'title' => 'Delete CartograTree subgroup',
      'description' => 'Delete an existing CartograTree subgroup.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_subgroup_form', 'delete'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // ==============================================================================================================
    // -- Add layer.
    $items['admin/cartogratree/settings/layer/add'] = array(
      'title' => 'Add CartograTree layer',
      'description' => 'Make a layer available to the CartograTree application.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_layer_form', 'add'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // -- Edit layer.
    $items['admin/cartogratree/settings/layer/edit'] = array(
      'title' => 'Edit CartograTree layer',
      'description' => 'Edit an existing CartograTree layer.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_layer_form', 'edit'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // -- Delete layer.
    $items['admin/cartogratree/settings/layer/delete'] = array(
      'title' => 'Delete CartograTree layer',
      'description' => 'Delete an existing CartograTree layer.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_settings_layer_form', 'delete'),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // ==============================================================================================================
    // Management of layers' access.
    // -- Add permissions
    $items['admin/cartogratree/settings/layer/access'] = array(
      'title' => 'Layer Permissions',
      'description' => 'Handle permissions for a layer.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('cartogratree_admin_layer_permissions_form', 5),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    // -- Remove (no confirm)
    $items['admin/cartogratree/settings/layer/access/%/%/%'] = array(
      'title' => 'Remove Layer Permissions',
      'description' => 'Handle permissions for a layer.',
      'page callback' => 'cartogratree_admin_layer_permission_remove_callback',
      'page arguments' => array(5, 6, 7),
      'access arguments' => array('administer cartogratree'),
      'file' => 'includes/cartogratree.admin.inc',
    );

    return $items;
}

/**
 * The user interface for CartograTree
 */
function cartogratree_app_page() {
    // pop-up window shown when the user tries to select more than four layers to show
    $content = "<div id=\"cartogratree_popup\" title=\"Layers\">
      Only four layers can be shown!<br/>Unselect one of the shown layers and try again.
    </div>";
    // pop-up window shown when the user clicks on one of the four maps
    $content .= "<div id=\"cartogratree_ol_popup\" class=\"cartogratree_ol_popup\">
      <a href=\"#\" id=\"cartogratree_ol_popup_closer\" class=\"cartogratree_ol_popup_closer\"></a>
      <div id=\"cartogratree_ol_popup_content\"></div>
    </div>";
    // side navigation panel
    $content .= "<span class=\"cartogratree_navbtn\">&#9776;</span>
    <div id=\"cartogratree_sidenav\">";
    // navigation tabs
    $content .= "<div id=\"cartogratree_steps\">
        <ul>
          <li><a href=\"#cartogratree_step_1\">Layers</a></li>
          <li><a href=\"#cartogratree_step_2\">Filters</a></li>
          <li><a href=\"#cartogratree_step_3\">Data</a></li>
        </ul>";
    // 'Layers' tab content
    $content .= "<div id=\"cartogratree_step_1\">
          Shown: <span id=\"cartogratree_layers_shown\">0</span>/4 Used: <span id=\"cartogratree_layers_used\">0</span>
          <div id=\"cartogratree_accordion_groups\">";
    // pass info to JS about this accordion
    $accordions = array('#cartogratree_accordion_groups');
    // accordion entries
    $groups = array(); $layers_js = array();
    $layers = cartogratree_get_layers();
    foreach ($layers as $l) {
        $groups[$l->group_rank]['group_name'] = $l->group_name;
        $groups[$l->group_rank]['group_rank'] = $l->group_rank;
        if ($l->subgroup_name != '[No subgroup]') {
            $groups[$l->group_rank]['has_subgroups'] = TRUE;
        }
        else {
            $groups[$l->group_rank]['has_subgroups'] = FALSE;
        }
        $groups[$l->group_rank]['subgroups'][$l->subgroup_rank]['subgroup_name'] = $l->subgroup_name;
        // add radio button for layer
        $layer = "cartogratree_sidenav_layer_" . $l->layer_id;
        $groups[$l->group_rank]['subgroups'][$l->subgroup_rank]['layers'][$l->layer_id] = "<div id=\"".$layer."\">
            <input type=\"radio\" id=\"".$layer."_radio1\" name=\"".$layer."_radio\"><label for=\"".$layer."_radio1\">show</label>
            <input type=\"radio\" id=\"".$layer."_radio2\" name=\"".$layer."_radio\"><label for=\"".$layer."_radio2\">use</label>
            <input type=\"radio\" id=\"".$layer."_radio3\" name=\"".$layer."_radio\" checked=\"checked\"><label for=\"".$layer."_radio3\">skip</label> ".$l->title."</div>";
        // pass info to JS about this layer
        array_push($layers_js, array('id' => $layer, 'name' => $l->name, 'title' => $l->title, 'url' => $l->url,));
    }
    foreach ($groups as $g) {
        $content .= "<h3>". $g['group_name'] . "</h3><div>";
        if ($g['has_subgroups']) {
            $content .= "<div id=\"cartogratree_accordion_group_" . $g['group_rank'] . "\">";
            // pass info to JS about this accordion
            array_push($accordions, "#cartogratree_accordion_group_" . $g['group_rank']);
        }
        foreach ($g['subgroups'] as $s) {
            if ($s['subgroup_name'] != '[No subgroup]') $content .= "<h4>". $s['subgroup_name'] . "</h4><div>";
            $content .= join (PHP_EOL, $s['layers']);
            if ($s['subgroup_name'] != '[No subgroup]') $content .= "</div>";
        }
        $content .= "</div>";
        if ($g['has_subgroups']) $content .= "</div>";
    }
    // End of accordion entries and 'Layers' tab content
    $content .= "</div></div>";

    // 'Filters' tab content
    $content .= "<div id=\"cartogratree_step_2\">";
    // ========================================================================================
    // demo content
    $content .= "Layers:
        <div id=\"cartogratree_accordion_filters\">
          <h3><a herf=\"#\">Trees filter</a></h3>
          <div id=\"cartogratree_demo_checkbox\">
            <fieldset>
              <legend>Tree species</legend>
              <input type=\"checkbox\" id=\"checkbox1\" name=\"checkbox\"><label for=\"checkbox1\">Abies alba</label>
              <input type=\"checkbox\" id=\"checkbox2\" name=\"checkbox\"><label for=\"checkbox2\">Cedrus deodara</label>
              <input type=\"checkbox\" id=\"checkbox3\" name=\"checkbox\"><label for=\"checkbox3\">Fagus grandifolia</label>
            </fieldset>
          </div>
          <h3><a herf=\"#\">Temperature filter</a></h3>
          <div>
            <div id=\"cartogratree_demo_slider_caption\">Minimum temperature: -20..20 °C</div>
            <div id=\"cartogratree_demo_slider\"></div>
          </div>
        </div>";
    // pass info to JS about this accordion
    array_push($accordions, "#cartogratree_accordion_filters");
    // end of demo content
    // ========================================================================================

//    // 'Old-style' content
//    $content .= "<b>Species:</b><br/>
//          <select id=\"cartogratree_trees_select\" class=\"cartogratree_select\" multiple>
//            <option selected=\"yes\">Abies alba</option>
//            <option selected=\"yes\">Cedrus deodara</option>
//            <option selected=\"yes\">Fagus grandifolia</option>
//          </select>";
    // End of 'Filters' tab content
    $content .= "</div>";
    // 'Data' tab content
    $content .= "<div id=\"cartogratree_step_3\"></div>";
    // End of navigation tabs
    $content .= "</div>";
    // End of side navigation panel
    $content .= "</div>";
    // four maps
    $content .= "<div id=\"cartogratree_squares\">
    <div class=\"cartogratree_row\">
      <div class=\"cartogratree_left\" id=\"cartogratree_top_left\"></div>
      <div class=\"cartogratree_right\" id=\"cartogratree_top_right\"></div>
    </div>
    <div class=\"cartogratree_row\">
      <div class=\"cartogratree_left\" id=\"cartogratree_bottom_left\"></div>
      <div class=\"cartogratree_right\" id=\"cartogratree_bottom_right\"></div>
    </div></div>";

    libraries_load('openlayers');
    foreach (['dialog', 'tabs', 'accordion', 'button', 'slider'] as $ui) {
        drupal_add_library('system', 'ui.' . $ui);
    }
    drupal_add_js(drupal_get_path('module', 'cartogratree') . '/cartogratree.js');
    drupal_add_css(drupal_get_path('module', 'cartogratree') . '/cartogratree.css'
//        , array('group' => CSS_THEME, 'weight' => 9999,)
        );
    $settings = array(
      'cartogratree' => array(
        'gis' => variable_get('cartogratree_gis'),
        'api' => variable_get('cartogratree_api'),
      ),
      'layers' => $layers_js,
      'accordions' => $accordions,
    );
    drupal_add_js($settings, 'setting');

    return array(
      '#type' => 'markup',
      '#markup' => $content,
    );
}

/**
 * Retrieve all layers the current user has permission to see.
 *
 * @return
 *   A prepared statement object, already executed.
 */
function cartogratree_get_layers() {
  global $user;
  // Grab the roles and user id of the current user.
  $uid = $user->uid;
  $rids = is_array($user->roles) ? array_keys($user->roles) : array();
  // Only grab layers that the current user has permission to see.
  $layers = db_query('
    SELECT l.layer_id, l.title, l.name, l.url, g.group_name, s.subgroup_name, g.group_rank, gs.subgroup_rank, l.layer_rank
    FROM {cartogratree_layer_permissions} p
    JOIN {cartogratree_layers} l ON l.layer_id=p.layer_id
    JOIN {cartogratree_groups} g ON g.group_id = l.group_id
    JOIN {cartogratree_subgroups} s ON s.subgroup_id = l.subgroup_id
    JOIN {cartogratree_groups_subgroups} gs ON g.group_id = gs.group_id AND s.subgroup_id = gs.subgroup_id
    WHERE p.uid=:uid OR p.rid IN (:rids)
    ORDER BY g.group_rank, gs.subgroup_rank, l.layer_rank',
    array(':uid' => $uid, ':rids' => $rids));
  return $layers;
}

/**
 * Implements hook_theme().
 * Specify how to render the arrays for both permissions tables on
 * ?q=admin/cartogratree/settings/layer/access/<layer id> as HTML;
 * and sub/group management tables on
 * ?q=admin/cartogratree/settings/group/subgroups/<group id>, and
 * ?q=admin/cartogratree/settings/subgroups/group/<subgroup id>
 */
function cartogratree_theme($existing, $type, $theme, $path) {
  $items = array();

  $items['cartogratree_admin_form_permission_table'] = array(
    'function' => 'cartogratree_admin_form_permission_table',
    'render element' => 'element',
    'file' => 'includes/cartogratree.admin.inc',
  );

  $items['cartogratree_admin_form_group_mgmt_table'] = array(
    'function' => 'cartogratree_admin_form_group_mgmt_table',
    'render element' => 'element',
    'file' => 'includes/cartogratree.admin.inc',
  );

  return $items;
}
